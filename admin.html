<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - QnA Kampung KB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Questions Section */
        .questions-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        /* Question Items */
        .question-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .question-item {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.3s;
        }

        .question-item:hover {
            background: #f8f9fa;
        }

        .question-item.answered {
            background: #f8fff8;
            border-left: 4px solid #28a745;
        }

        .question-item.pending {
            background: #fff8f0;
            border-left: 4px solid #ffc107;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .author-name {
            font-weight: bold;
            color: #1e3c72;
        }

        .question-time {
            background: #e9ecef;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #666;
        }

        .question-category {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .question-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-answered {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .question-text {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-style: italic;
        }

        /* Answer Section */
        .answer-section {
            margin-top: 1rem;
        }

        .current-answer {
            background: #d4edda;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #28a745;
        }

        .answer-label {
            font-weight: bold;
            color: #155724;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .answer-form {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .answer-textarea {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .submit-answer-btn {
            background: #1e3c72;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .submit-answer-btn:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }

        .submit-answer-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading::after {
            content: "...";
            animation: dots 2s infinite;
        }

        @keyframes dots {
            0% { content: ""; }
            25% { content: "."; }
            50% { content: ".."; }
            75% { content: "..."; }
            100% { content: ""; }
        }

        /* Success Message */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .container {
                padding: 0 1rem;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .question-meta {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .answer-form {
                flex-direction: column;
            }

            .submit-answer-btn {
                width: 100%;
            }
        }

        /* Custom Scrollbar */
        .question-list::-webkit-scrollbar {
            width: 8px;
        }

        .question-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .question-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .question-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1>üéØ Admin Dashboard</h1>
                <p>Kelola Pertanyaan QnA Kampung KB</p>
            </div>
            <div class="admin-badge">
                üë®‚Äçüíº Admin Mode
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">-</div>
                <div class="stat-label">Total Pertanyaan</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingQuestions">-</div>
                <div class="stat-label">Menunggu Jawaban</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="answeredQuestions">-</div>
                <div class="stat-label">Sudah Dijawab</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayQuestions">-</div>
                <div class="stat-label">Pertanyaan Hari Ini</div>
            </div>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            ‚úÖ Jawaban berhasil disimpan!
        </div>

        <!-- Questions Section -->
        <div class="questions-section">
            <div class="section-header">
                <h2 class="section-title">üìã Daftar Pertanyaan</h2>
                <button class="refresh-btn" onclick="loadQuestions()">
                    üîÑ Refresh Data
                </button>
            </div>
            
            <div class="question-list" id="questionsList">
                <div class="loading" id="loadingMessage">
                    Memuat data dari Google Sheets
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '14gRlgi-XiDMPiaU-cga2FZE_n09NYIIFcTQo3xOskBU'; // ID Sheet
const SHEET_NAME = 'Form Responses 1';
const API_KEY = 'API_KEY_KAMU'; // sama seperti di index.html
const SCRIPT_URL = 'PASTE_WEB_APP_URL_DISINI'; // dari Apps Script
let questionsData = [];

  // ====== KONFIGURASI ======
  const SHEET_ID   = '14gRlgi-XiDMPiaU-cga2FZE_n09NYIIFcTQo3xOskBU';
  const API_KEY    = 'AIzaSyAoIM03NMmaPuKx4VuI40aWP0Ukoq-_HHA';
  const SHEET_NAME = 'Form Responses 1';   // nama tab tepat (case-sensitive)
  const RANGE      = 'A:E';                // sesuaikan kalau kolom melebar

  // Helper tampilkan status
  function showConnectionStatus(isConnected, message) {
    const el = document.getElementById('connectionStatus');
    if (!el) return;
    el.innerHTML = isConnected
      ? '<div class="success-indicator">‚úÖ Terhubung ke database - Data real time aktif</div>'
      : `<div class="error-message">‚ö†Ô∏è ${message} - Menampilkan data contoh sementara</div>`;
  }

  // Format waktu simpel
  function formatTime(ts) {
    if (!ts) return 'Waktu tidak diketahui';
    const now = new Date();
    const t   = new Date(ts);
    const diffH = Math.floor((now - t) / (1000 * 60 * 60));
    const diffD = Math.floor(diffH / 24);
    if (diffD > 0) return `${diffD} hari yang lalu`;
    if (diffH > 0) return `${diffH} jam yang lalu`;
    return 'Baru saja';
  }

  // Render ke UI (SESUIKAN dengan punyamu)
  function renderQuestions(questions, isReal) {
    const wrap = document.getElementById('questionsDisplay');
    const loading = document.getElementById('loadingMessage');
    if (loading) loading.style.display = 'none';
    if (!wrap) return;

    if (!questions || questions.length === 0) {
      wrap.innerHTML = `
        <h4>üí¨ Pertanyaan & Jawaban Terbaru</h4>
        <div class="question-item"><p style="text-align:center;color:#666">Belum ada pertanyaan.</p></div>`;
      return;
    }

    const srcInfo = isReal
      ? '<p style="text-align:center;color:#28a745;font-size:.9rem;margin-bottom:1rem;">üì° Data real-time dari Google Sheets</p>'
      : '<p style="text-align:center;color:#ffc107;font-size:.9rem;margin-bottom:1rem;">‚ö†Ô∏è Menampilkan data contoh (fallback)</p>';

    const html = questions.map(q => `
      <div class="question-item">
        <div class="question-header">
          <span class="question-author">üë§ ${q.name || 'Penanya Anonim'}</span>
          <span class="question-time">üïí ${q.time || 'Waktu tidak diketahui'}</span>
        </div>
        <div class="question-text">${q.question || 'Pertanyaan tidak tersedia'}</div>
        <div style="margin-top:.5rem;">
          <span class="question-category" style="background:#2a5298;">üìÇ ${q.category || 'Umum'}</span>
        </div>
        ${q.answer ? `
          <div class="answer">
            <div class="answer-header">üí° Jawaban:</div>
            <div class="answer-text">${q.answer}</div>
          </div>` : ''}
      </div>
    `).join('');

    wrap.innerHTML = `<h4>üí¨ Pertanyaan & Jawaban Terbaru</h4>${srcInfo}${html}`;
  }

  // Parser hasil API v4 -> array objek
  function mapRowsByHeader(values) {
    // values[0] = header
    const headers = values[0].map(h => (h || '').trim().toLowerCase());
    const idx = {
      timestamp: headers.indexOf('timestamp'),
      name:      headers.indexOf('nama') > -1 ? headers.indexOf('nama') : headers.indexOf('name'),
      question:  headers.indexOf('pertanyaan') > -1 ? headers.indexOf('pertanyaan') : headers.indexOf('question'),
      category:  headers.indexOf('kategori') > -1 ? headers.indexOf('kategori') : headers.indexOf('category'),
      answer:    headers.indexOf('jawaban') > -1 ? headers.indexOf('jawaban') : headers.indexOf('answer'),
      email:     headers.indexOf('email')
    };

    const rows = values.slice(1);
    return rows.map(r => ({
      time:     idx.timestamp > -1 ? formatTime(r[idx.timestamp]) : null,
      name:     idx.name > -1 ? (r[idx.name] || '').trim() : 'Penanya Anonim',
      question: idx.question > -1 ? (r[idx.question] || '') : '',
      category: idx.category > -1 ? (r[idx.category] || 'Umum') : 'Umum',
      status:   idx.answer > -1 && r[idx.answer] ? 'answered' : 'pending',
      answer:   idx.answer > -1 ? (r[idx.answer] || null) : null,
      email:    idx.email > -1 ? (r[idx.email] || null) : null
    })).reverse(); // terbaru dulu
  }

  // Fetch via Google Sheets API v4 (butuh API key, sheet publik viewer)
  async function fetchViaV4() {
    const rangeStr = encodeURIComponent(`${SHEET_NAME}!${RANGE}`);
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${rangeStr}?key=${API_KEY}`;
    const res = await fetch(url);
    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error(`Sheets v4 error ${res.status}: ${text || res.statusText}`);
    }
    const data = await res.json();
    if (!data.values || data.values.length === 0) return [];
    return mapRowsByHeader(data.values);
  }

  // Fallback super-andal: endpoint publik gviz (tanpa API key)
  async function fetchViaGviz() {
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`GViz error ${res.status}`);
    const txt = await res.text();
    // GViz bungkus JSON dalam setResponse(...); ambil JSON‚Äënya
    const jsonStr = txt.replace(/^[^{]+/, '').replace(/;?\s*$/,''); // buang wrapper sampai '{' pertama & ; di akhir
    const obj = JSON.parse(jsonStr);
    const cols = obj.table.cols.map(c => (c.label || '').trim().toLowerCase());
    const rows = obj.table.rows || [];

    // Cari indeks yang mirip
    const idxMap = {
      timestamp: cols.findIndex(c => c.includes('timestamp')),
      name:      cols.findIndex(c => ['nama','name'].includes(c)),
      question:  cols.findIndex(c => ['pertanyaan','question'].includes(c)),
      category:  cols.findIndex(c => ['kategori','category'].includes(c)),
      answer:    cols.findIndex(c => ['jawaban','answer'].includes(c)),
      email:     cols.findIndex(c => c === 'email')
    };

    const out = rows.map(r => {
      const cells = r.c || [];
      const get = i => (i > -1 && cells[i] && cells[i].v != null) ? String(cells[i].v) : '';
      const ts = get(idxMap.timestamp);
      return {
        time:     ts ? formatTime(ts) : null,
        name:     get(idxMap.name) || 'Penanya Anonim',
        question: get(idxMap.question),
        category: get(idxMap.category) || 'Umum',
        status:   get(idxMap.answer) ? 'answered' : 'pending',
        answer:   get(idxMap.answer) || null,
        email:    get(idxMap.email) || null
      };
    }).reverse();

    return out;
  }

  // ====== PANGGIL UTAMA ======
  async function loadQuestionsFromSheet() {
    const loading = document.getElementById('loadingMessage');
    if (loading) loading.style.display = 'block';

    try {
      // Coba API v4 dulu (sesuai permintaan: tetap pakai API key public)
      const data = await fetchViaV4();
      showConnectionStatus(true, '');
      renderQuestions(data, true);
    } catch (err) {
      console.warn('Sheets v4 gagal, fallback ke gviz ‚Üí', err);
      try {
        const data = await fetchViaGviz();
        showConnectionStatus(false, 'Koneksi API v4 gagal');
        renderQuestions(data, false);
      } catch (err2) {
        console.error('Fallback gviz juga gagal ‚Üí', err2);
        showConnectionStatus(false, 'Gagal memuat data (v4 & gviz)');
        // Terakhir: tampilkan sample minimal biar halaman gak kosong
        renderQuestions([{
          name: 'Tim Admin',
          question: 'Silakan ajukan pertanyaan Anda melalui form.',
          category: 'Informasi',
          time: 'Baru saja',
          status: 'answered',
          answer: 'Pertanyaan yang masuk akan tampil di sini setelah diproses.'
        }], false);
      }
    }
  }

  // Inisialisasi
  document.addEventListener('DOMContentLoaded', loadQuestionsFromSheet);
</script>


</body>

</html>


