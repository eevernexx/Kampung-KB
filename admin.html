<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - QnA Kampung KB</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Questions Section */
        .questions-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #1e3c72;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        /* Question Items */
        .question-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .question-item {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f3f4;
            transition: background 0.3s;
        }

        .question-item:hover {
            background: #f8f9fa;
        }

        .question-item.answered {
            background: #f8fff8;
            border-left: 4px solid #28a745;
        }

        .question-item.pending {
            background: #fff8f0;
            border-left: 4px solid #ffc107;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .author-name {
            font-weight: bold;
            color: #1e3c72;
        }

        .question-time {
            background: #e9ecef;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #666;
        }

        .question-category {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .question-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-answered {
            background: #d4edda;
            color: #155724;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .question-text {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-style: italic;
        }

        /* Answer Section */
        .answer-section {
            margin-top: 1rem;
        }

        .current-answer {
            background: #d4edda;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #28a745;
        }

        .answer-label {
            font-weight: bold;
            color: #155724;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .answer-form {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }

        .answer-textarea {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .answer-textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        .submit-answer-btn {
            background: #1e3c72;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .submit-answer-btn:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }

        .submit-answer-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .loading::after {
            content: "...";
            animation: dots 2s infinite;
        }

        @keyframes dots {
            0% { content: ""; }
            25% { content: "."; }
            50% { content: ".."; }
            75% { content: "..."; }
            100% { content: ""; }
        }

        /* Success Message */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .container {
                padding: 0 1rem;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .question-meta {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .answer-form {
                flex-direction: column;
            }

            .submit-answer-btn {
                width: 100%;
            }
        }

        /* Custom Scrollbar */
        .question-list::-webkit-scrollbar {
            width: 8px;
        }

        .question-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .question-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .question-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div>
                <h1>üéØ Admin Dashboard</h1>
                <p>Kelola Pertanyaan QnA Kampung KB</p>
            </div>
            <div class="admin-badge">
                üë®‚Äçüíº Admin Mode
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">-</div>
                <div class="stat-label">Total Pertanyaan</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingQuestions">-</div>
                <div class="stat-label">Menunggu Jawaban</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="answeredQuestions">-</div>
                <div class="stat-label">Sudah Dijawab</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayQuestions">-</div>
                <div class="stat-label">Pertanyaan Hari Ini</div>
            </div>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            ‚úÖ Jawaban berhasil disimpan!
        </div>

        <!-- Questions Section -->
        <div class="questions-section">
            <div class="section-header">
                <h2 class="section-title">üìã Daftar Pertanyaan</h2>
                <button class="refresh-btn" onclick="loadQuestions()">
                    üîÑ Refresh Data
                </button>
            </div>
            
            <div class="question-list" id="questionsList">
                <div class="loading" id="loadingMessage">
                    Memuat data dari Google Sheets
                </div>
            </div>
        </div>
    </div>

    <script>
  // === CONFIG ===
  const APP_URL = 'PASTE_WEB_APP_URL_HERE'; // <-- ganti dengan URL Web App dari Apps Script
  const categoryColors = {
    'umum':'#6c757d','program kb':'#007bff','kegiatan kampung kb':'#28a745','layanan kesehatan':'#17a2b8','administrasi':'#fd7e14'
  };

  let questionsData = []; // akan diisi dari server

  function formatTime(ts){
    const d = new Date(ts), now = new Date();
    const diff = now - d, h = Math.floor(diff/36e5), day = Math.floor(h/24);
    if (isNaN(d.getTime())) return '-';
    if (day>0) return `${day} hari yang lalu`;
    if (h>0) return `${h} jam yang lalu`;
    return 'Baru saja';
  }

  // READ: ambil data dari Web App
  async function loadQuestions(){
    try{
      document.getElementById('loadingMessage').style.display = 'block';
      const res = await fetch(`${APP_URL}?action=list`, {method:'GET'});
      const data = await res.json();
      questionsData = (data.items || []).sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));
      displayQuestions(questionsData);
      updateStats(questionsData);
      document.getElementById('loadingMessage').style.display = 'none';
    }catch(e){
      console.error(e);
      document.getElementById('questionsList').innerHTML = `
        <div class="empty-state">
          <h3>Gagal memuat data</h3><p>${String(e)}</p>
        </div>`;
    }
  }

  // WRITE: kirim jawaban ke Web App
  async function submitAnswer(row){
    const textarea = document.querySelector(`[data-question-id="${row}"]`);
    const answer = (textarea?.value || '').trim();
    if (!answer) { alert('Silakan masukkan jawaban terlebih dahulu'); return; }

    const btn = textarea.parentElement.querySelector('button');
    btn.disabled = true; btn.textContent = 'Menyimpan...';

    try{
      const res = await fetch(APP_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({row, answer})
      });
      const result = await res.json();
      if (!result.ok) throw new Error(result.error || 'Gagal menyimpan');

      // update di memori & refresh tampilan
      const idx = questionsData.findIndex(q => q.row === row);
      if (idx > -1) {
        questionsData[idx].answer = answer;
      }
      displayQuestions(questionsData);
      updateStats(questionsData);

      // toast sederhana
      const msg = document.getElementById('successMessage');
      msg.style.display='block'; setTimeout(()=>msg.style.display='none', 2500);
    }catch(e){
      alert('Gagal menyimpan jawaban: ' + String(e));
    }finally{
      btn.disabled = false; btn.textContent = '‚úèÔ∏è Update Jawaban';
    }
  }

  function updateStats(data){
    const total = data.length;
    const pending = data.filter(q => !q.answer).length;
    const answered = total - pending;
    const todayStr = new Date().toISOString().slice(0,10);
    const todayCount = data.filter(q => {
      const d = new Date(q.timestamp); return d.toISOString().slice(0,10) === todayStr;
    }).length;

    document.getElementById('totalQuestions').textContent = total;
    document.getElementById('pendingQuestions').textContent = pending;
    document.getElementById('answeredQuestions').textContent = answered;
    document.getElementById('todayQuestions').textContent = todayCount;
  }

  function displayQuestions(data){
    const container = document.getElementById('questionsList');
    if (!data.length) {
      container.innerHTML = `
        <div class="empty-state"><h3>üìù Belum Ada Pertanyaan</h3><p>Pertanyaan dari pengguna akan muncul di sini</p></div>`;
      return;
    }

    const html = data.map(q=>{
      const catKey = (q.category||'Umum').toLowerCase();
      const catColor = categoryColors[catKey] || categoryColors.umum;
      const statusAnswered = !!q.answer;

      return `
        <div class="question-item ${statusAnswered ? 'answered':'pending'}" data-id="${q.row}">
          <div class="question-header">
            <div class="question-meta">
              <span class="author-name">üë§ ${q.name||'Penanya Anonim'}</span>
              ${q.email ? `<span class="question-time">‚úâÔ∏è ${q.email}</span>`:''}
              <span class="question-time">üïí ${formatTime(q.timestamp)}</span>
              <span class="question-category" style="background:${catColor}">üìÇ ${q.category||'Umum'}</span>
            </div>
            <span class="question-status ${statusAnswered ? 'status-answered':'status-pending'}">
              ${statusAnswered ? '‚úÖ Sudah Dijawab' : '‚è≥ Menunggu Jawaban'}
            </span>
          </div>

          <div class="question-text">üí¨ "${q.question||'-'}"</div>

          <div class="answer-section">
            ${statusAnswered ? `
              <div class="current-answer">
                <div class="answer-label">üí° Jawaban Saat Ini:</div>
                <div>${q.answer}</div>
              </div>` : ''}

            <div class="answer-form">
              <textarea class="answer-textarea" placeholder="Ketik jawaban untuk pertanyaan ini..." data-question-id="${q.row}">${q.answer||''}</textarea>
              <button class="submit-answer-btn" onclick="submitAnswer(${q.row})">
                ${statusAnswered ? '‚úèÔ∏è Update Jawaban' : 'üì§ Kirim Jawaban'}
              </button>
            </div>
          </div>
        </div>`;
    }).join('');

    container.innerHTML = html;
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadQuestions();
    setInterval(loadQuestions, 60000); // optional auto-refresh
  });
</script>

</body>

</html>
